var Passage=function(){"use strict";function t(t,e){if(void 0!==t&&void 0!==this._events[t])for(var n=0;n<this._events[t].length;n++)this._events[t][n](e)}function e(t,e,n){if(void 0!==t&&void 0!==this._callbacks[t])if(e){var i=new Error(e.message);i.code=e.code,i.data=e.data,this._callbacks[t](i)}else this._callbacks[t](void 0,n);delete this._callbacks[t]}var n={INVALID:"invalid",RESPONSE:"response",NOTIFICATION:"notification"};function i(t){return"object"!=typeof t?n.INVALID:"2.0"!==t.jsonrpc?n.INVALID:void 0!==t.method?n.NOTIFICATION:void 0===t.id?n.INVALID:void 0!==t.error?n.RESPONSE:void 0!==t.result?n.RESPONSE:n.INVALID}function o(t){return function(){if(void 0!==this._callbacks[t]){var e=new Error("Timeout");e.code=408,this._callbacks[t](e),delete this._callbacks[t]}}}function s(t,e){return"number"==typeof t?t:e}return function(c){function r(t,e){e=e||{},this.uri=t,this.options={requestTimeout:s(e.requestTimeout,6e3),reconnect:!!e.reconnect,reconnectTimeout:s(e.reconnectTimeout,2e3),reconnectTries:s(e.reconnectTries,60)},this._nextId=1,this._tries=0,this._callbacks={},this._events={},this.connect()}return r.prototype.close=function(){void 0!==this.connection&&(this.connection.killed=!0,this.connection.close())},r.prototype.connect=function(){this.close(),this.connection=new c(this.uri),this.connection.addEventListener("open",function(){this._tries=0,t.call(this,"rpc.open")}.bind(this)),this.connection.addEventListener("close",function(){this.options.reconnect&&!this.connection.killed&&this._tries<=this.options.reconnectTries&&(this._tries++,setTimeout(this.connect.bind(this),this.options.reconnectTimeout)),t.call(this,"rpc.close")}.bind(this)),this.connection.addEventListener("error",function(e){t.call(this,"rpc.error",e)}.bind(this)),this.connection.addEventListener("message",function(o){var s;t.call(this,"rpc.message",o.data);try{s=JSON.parse(o.data),Array.isArray(s)||(s=[s])}catch(t){return}for(var c=0;c<s.length;c++){var r=s[c];switch(i(r)){case n.NOTIFICATION:t.call(this,r.method,r.params);break;case n.RESPONSE:e.call(this,r.id,r.error,r.result)}}}.bind(this))},r.prototype.sendAll=function(t,e){if(void 0!==this.connection){for(var n=function(t){for(var e=[],n=0;n<t.length;n++){var i=t[n];if("object"==typeof i&&"string"==typeof i.method){var o={id:"function"==typeof i.callback?this._nextId++:void 0,method:i.method,params:i.params,jsonrpc:"2.0"};e.push({id:o.id,payload:JSON.stringify(o),callback:i.callback})}else"function"==typeof i.callback&&i.callback(new Error("Invalid payload"))}return e}.call(this,t),i=0;i<n.length;i++){var c=n[i].id;if(void 0!==c){this._callbacks[c]=n[i].callback;var r=s(e,this.options.requestTimeout);setTimeout(o(c).bind(this),r)}}n.length>1?this.connection.send("["+n.map(function(t){return t.payload}).join(",")+"]"):1===n.length&&this.connection.send(n[0].payload)}else for(var a=0;a<t.length;a++)"function"==typeof t[a].callback&&t[a].callback(new Error("No connection"))},r.prototype.send=function(t,e,n,i){"function"==typeof e&&(i=n,n=e,e=void 0);const o={method:t,params:e,callback:n};this.sendAll([o],i)},r.prototype.addEventListener=function(t,e){this._events[t]=this._events[t]||[],this._events[t].push(e)},r.prototype.removeEventListeners=function(t){delete this._events[t]},r.prototype.removeEventListener=function(t,e){if(void 0!==this._events[t]){var n=this._events[t].indexOf(e);n<0||(this._events[t].length<=1?this.removeEventListeners(t):this._events[t].splice(n,1))}},r}(WebSocket)}();
